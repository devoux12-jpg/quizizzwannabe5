<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Ujian Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Impor Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .radio-custom:checked + label {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
            border-color: #3b82f6; /* border-blue-500 */
        }
        .radio-custom + label {
            transition: all 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center justify-center min-h-screen">

   

    <div class="container mx-auto p-4 max-w-2xl w-full">
        <div class="bg-white p-8 rounded-2xl shadow-lg transition-all duration-500">

            <!-- Tampilan Awal -->
            <div id="initial-view" class="view active">
                <h1 class="text-3xl font-bold text-center text-gray-700 mb-2">Selamat Datang!</h1>
                <p class="text-center text-gray-500 mb-8">Silakan buat ujian baru atau masukkan kata sandi untuk memulai ujian.</p>
                <div class="flex flex-col gap-4">
                    <button id="show-create-exam-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        Buat Ujian Baru
                    </button>
                    <div class="border-t border-gray-200 my-2"></div>
                    <h2 class="text-lg font-semibold text-center text-gray-600">Kerjakan Ujian</h2>
                    <input type="text" id="password-input" placeholder="Masukkan Kata Sandi Ujian" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="start-exam-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        Mulai Kerjakan
                    </button>
                </div>
            </div>

            <!-- Tampilan Buat Ujian -->
            <div id="create-exam-view" class="view">
                <h1 class="text-2xl font-bold mb-6 text-gray-700">Formulir Pembuatan Soal</h1>
                <div class="space-y-4">
                    <textarea id="question-input" placeholder="Tuliskan pertanyaan Anda di sini..." class="w-full h-28 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                    <input type="text" id="option-a" placeholder="Pilihan Jawaban A" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="option-b" placeholder="Pilihan Jawaban B" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="option-c" placeholder="Pilihan Jawaban C" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="option-d" placeholder="Pilihan Jawaban D" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <select id="correct-answer" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="" disabled selected>Pilih Jawaban Benar</option>
                        <option value="A">Jawaban A</option>
                        <option value="B">Jawaban B</option>
                        <option value="C">Jawaban C</option>
                        <option value="D">Jawaban D</option>
                    </select>
                </div>
                <div class="flex gap-4 mt-6">
                     <button id="add-question-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Tambah Soal</button>
                     <button id="finish-exam-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Selesai & Buat Ujian</button>
                </div>
                 <div class="mt-6">
                    <h3 class="font-semibold text-gray-600">Soal Ditambahkan: <span id="question-count">0</span></h3>
                    <ul id="questions-list" class="list-decimal list-inside mt-2 text-gray-500"></ul>
                </div>
                <button class="mt-4 text-sm text-gray-500 hover:text-blue-500" onclick="showView('initial-view')">&larr; Kembali ke Menu Utama</button>
            </div>

            <!-- Tampilan Password Ujian -->
            <div id="password-display-view" class="view text-center">
                <h1 class="text-2xl font-bold text-green-600 mb-4">Ujian Berhasil Dibuat!</h1>
                <p class="text-gray-600 mb-4">Bagikan kata sandi ini kepada peserta ujian:</p>
                <div class="bg-gray-100 p-4 rounded-lg inline-block border-2 border-dashed border-gray-300">
                    <span id="generated-password" class="text-4xl font-mono font-bold tracking-widest text-gray-800"></span>
                </div>
                <p class="text-sm text-gray-500 mt-4">Peserta dapat menggunakan kata sandi ini di halaman utama.</p>
                <button class="mt-8 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg" onclick="showView('initial-view')">Kembali ke Menu Utama</button>
            </div>

            <!-- Tampilan Mengerjakan Ujian -->
            <div id="take-exam-view" class="view">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-2xl font-bold text-gray-700">Soal Ujian</h1>
                     <div class="text-lg font-semibold bg-gray-100 px-4 py-1 rounded-lg">
                        Soal <span id="current-question-number"></span>/<span id="total-questions"></span>
                    </div>
                </div>
                <div id="question-container" class="bg-gray-50 p-6 rounded-lg mb-6">
                    <p id="exam-question" class="text-lg font-medium mb-4"></p>
                    <div id="exam-options" class="space-y-3"></div>
                </div>
                <div class="flex justify-between">
                    <button id="prev-question-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Sebelumnya</button>
                    <button id="next-question-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">Selanjutnya</button>
                    <button id="submit-exam-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg hidden">Kumpulkan</button>
                </div>
            </div>

            <!-- Tampilan Hasil Ujian -->
            <div id="result-view" class="view text-center">
                <h1 class="text-2xl font-bold text-gray-700 mb-4">Hasil Ujian Anda</h1>
                <div class="bg-blue-100 border-t-4 border-blue-500 rounded-b text-blue-900 px-4 py-3 shadow-md mb-6" role="alert">
                  <div class="flex items-center justify-center">
                    <div class="py-1"><svg class="fill-current h-8 w-8 text-blue-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M10 20a10 10 0 1 1 0-20 10 10 0 0 1 0 20zm-1-11V5h2v4h1v2h-1v2h-2v-2H8v-2h1z"/></svg></div>
                    <div>
                      <p class="font-bold text-3xl" id="score-text"></p>
                      <p class="text-sm" id="score-details"></p>
                    </div>
                  </div>
                </div>
                <button class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg" onclick="showView('initial-view')">Kembali ke Menu Utama</button>
            </div>
        </div>
    </div>

    <!-- Modal Kustom (Pengganti alert dan confirm) -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-2xl bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Pemberitahuan</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="modal-message"></p>
                </div>
                <div class="items-center px-4 py-3" id="modal-buttons">
                    <button id="modal-confirm-btn" class="hidden px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                        Ya
                    </button>
                    <button id="modal-cancel-btn" class="hidden ml-3 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Batal
                    </button>
                    <button id="modal-ok-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SUPABASE SETUP ---
        // GANTI DENGAN URL DAN KUNCI ANON ANDA DARI SUPABASE
        const SUPABASE_URL = '';
        const SUPABASE_KEY = '';
        
        let db;
        const { createClient } = supabase;

        // Langsung inisialisasi client
        try {
            db = createClient(SUPABASE_URL, SUPABASE_KEY);
            if (!db) {
                throw new Error("Supabase client creation failed silently.");
            }
            console.log("Supabase client initialized.");
        } catch (error) {
            console.error("Inisialisasi Supabase Gagal. Periksa URL dan Key.", error.message);
            
            // Jika inisialisasi gagal, nonaktifkan tombol-tombol utama
            document.addEventListener('DOMContentLoaded', () => {
                try {
                    document.getElementById('start-exam-btn').disabled = true;
                    document.getElementById('finish-exam-btn').disabled = true;
                    document.getElementById('start-exam-btn').textContent = 'Konfigurasi Gagal';
                    document.getElementById('show-create-exam-btn').disabled = true;
                } catch(e) {
                    console.error("Tidak dapat menonaktifkan tombol.", e);
                }
            });
        }
        // --- END SUPABASE SETUP ---


        // Database sementara untuk *soal yang sedang dibuat*
        let currentQuestions = [];
        // Data untuk ujian yang *sedang dikerjakan*
        let currentExamData = [];
        let userAnswers = {};
        let currentQuestionIndex = 0;

        // Elemen-elemen DOM
        const views = document.querySelectorAll('.view');
        const showCreateExamBtn = document.getElementById('show-create-exam-btn');
        const startExamBtn = document.getElementById('start-exam-btn');
        const addQuestionBtn = document.getElementById('add-question-btn');
        const finishExamBtn = document.getElementById('finish-exam-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const prevQuestionBtn = document.getElementById('prev-question-btn');
        const submitExamBtn = document.getElementById('submit-exam-btn');

        // --- Modal ---
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalButtons = document.getElementById('modal-buttons');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        
        let confirmCallback = null;

        function showModal(message) {
            modalTitle.textContent = 'Pemberitahuan';
            modalMessage.textContent = message;
            modalOkBtn.classList.remove('hidden');
            modalConfirmBtn.classList.add('hidden');
            modalCancelBtn.classList.add('hidden');
            modal.classList.remove('hidden');
        }
        
        function showConfirm(message, callback) {
            modalTitle.textContent = 'Konfirmasi';
            modalMessage.textContent = message;
            modalOkBtn.classList.add('hidden');
            modalConfirmBtn.classList.remove('hidden');
            modalCancelBtn.classList.remove('hidden');
            modal.classList.remove('hidden');
            confirmCallback = callback;
        }

        modalOkBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });
        
        modalCancelBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            if (confirmCallback) {
                confirmCallback(false);
                confirmCallback = null;
            }
        });
        
        modalConfirmBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            if (confirmCallback) {
                confirmCallback(true);
                confirmCallback = null;
            }
        });
        // --- End Modal ---

        // Fungsi untuk menavigasi antar tampilan
        function showView(viewId) {
            views.forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            // Reset state saat kembali ke menu utama
            if (viewId === 'initial-view') {
                currentQuestions = [];
                currentExamData = [];
                userAnswers = {};
                currentQuestionIndex = 0;
                document.getElementById('question-count').textContent = '0';
                document.getElementById('questions-list').innerHTML = '';
                document.getElementById('password-input').value = '';
                
                // Reset tombol loading (jika ada)
                startExamBtn.disabled = false;
                startExamBtn.textContent = 'Mulai Kerjakan';
                finishExamBtn.disabled = false;
                finishExamBtn.textContent = 'Selesai & Buat Ujian';
            }
        }
        
        // Fungsi validasi form pembuatan soal
        function validateQuestionForm() {
            const question = document.getElementById('question-input').value.trim();
            const optA = document.getElementById('option-a').value.trim();
            const optB = document.getElementById('option-b').value.trim();
            const optC = document.getElementById('option-c').value.trim();
            const optD = document.getElementById('option-d').value.trim();
            const correct = document.getElementById('correct-answer').value;

            if (!question || !optA || !optB || !optC || !optD || !correct) {
                showModal('Harap isi semua kolom pertanyaan dan jawaban, serta pilih jawaban yang benar.');
                return false;
            }
            return { question, options: { A: optA, B: optB, C: optC, D: optD }, correct };
        }
        
        // Fungsi untuk mereset form pembuatan soal
        function resetQuestionForm() {
            document.getElementById('question-input').value = '';
            document.getElementById('option-a').value = '';
            document.getElementById('option-b').value = '';
            document.getElementById('option-c').value = '';
            document.getElementById('option-d').value = '';
            document.getElementById('correct-answer').value = '';
        }

        // Event listener untuk tombol-tombol
        showCreateExamBtn.addEventListener('click', () => showView('create-exam-view'));

        addQuestionBtn.addEventListener('click', () => {
            const newQuestion = validateQuestionForm();
            if (newQuestion) {
                currentQuestions.push(newQuestion);
                document.getElementById('question-count').textContent = currentQuestions.length;
                const listItem = document.createElement('li');
                listItem.textContent = `${currentQuestions.length}. ${newQuestion.question.substring(0, 30)}...`;
                document.getElementById('questions-list').appendChild(listItem);
                resetQuestionForm();
            }
        });

        // (MODIFIED) Menyimpan ujian ke Supabase
        finishExamBtn.addEventListener('click', async () => {
            if (currentQuestions.length === 0) {
                showModal('Silakan tambahkan setidaknya satu soal sebelum menyelesaikan.');
                return;
            }

            // Tampilkan loading
            finishExamBtn.disabled = true;
            finishExamBtn.textContent = 'Menyimpan...';

            const password = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            const { data, error } = await db
                .from('ujian') // 'ujian' adalah nama tabel Anda
                .insert({
                    password: password,
                    questions: currentQuestions // Simpan sebagai JSONB
                })
                .select();

            // Sembunyikan loading
            finishExamBtn.disabled = false;
            finishExamBtn.textContent = 'Selesai & Buat Ujian';

            if (error) {
                console.error('Error saving exam:', error);
                showModal('Gagal menyimpan ujian: ' + error.message);
                return;
            }

            document.getElementById('generated-password').textContent = password;
            showView('password-display-view');
        });

        // (MODIFIED) Memulai ujian dari Supabase
        startExamBtn.addEventListener('click', async () => {
            const password = document.getElementById('password-input').value.trim().toUpperCase();
            if (!password) return;

            // Tampilkan loading
            startExamBtn.disabled = true;
            startExamBtn.textContent = 'Mencari Ujian...';

            const { data, error } = await db
                .from('ujian')
                .select('questions') // Ambil hanya kolom questions
                .eq('password', password)
                .single(); // Ambil satu baris data

            // Sembunyikan loading
            startExamBtn.disabled = false;
            startExamBtn.textContent = 'Mulai Kerjakan';

            if (error || !data) {
                console.error('Error fetching exam:', error);
                showModal('Kata sandi ujian tidak valid atau tidak ditemukan.');
                return;
            }
            
            // Simpan data ujian yang diambil ke variabel global
            currentExamData = data.questions; 
            currentQuestionIndex = 0;
            userAnswers = {};
            renderQuestion();
            showView('take-exam-view');
        });

        // (MODIFIED) Render pertanyaan dari 'currentExamData'
        function renderQuestion() {
            const exam = currentExamData; // Menggunakan data yang sudah diambil
            const questionData = exam[currentQuestionIndex];
            
            document.getElementById('exam-question').textContent = questionData.question;
            const optionsContainer = document.getElementById('exam-options');
            optionsContainer.innerHTML = '';
            
            Object.entries(questionData.options).forEach(([key, value]) => {
                const optionId = `q${currentQuestionIndex}-opt${key}`;
                const checked = userAnswers[currentQuestionIndex] === key ? 'checked' : '';
                
                const optionHTML = `
                    <div>
                        <input type="radio" name="question${currentQuestionIndex}" id="${optionId}" value="${key}" class="radio-custom hidden" ${checked}>
                        <label for="${optionId}" class="block w-full text-left p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-100">
                            <span class="font-bold mr-2">${key}.</span> ${value}
                        </label>
                    </div>
                `;
                optionsContainer.insertAdjacentHTML('beforeend', optionHTML);
            });
            
            optionsContainer.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    userAnswers[currentQuestionIndex] = e.target.value;
                });
            });

            document.getElementById('current-question-number').textContent = currentQuestionIndex + 1;
            document.getElementById('total-questions').textContent = exam.length;

            prevQuestionBtn.disabled = currentQuestionIndex === 0;
            prevQuestionBtn.classList.toggle('opacity-50', currentQuestionIndex === 0);
            
            nextQuestionBtn.classList.toggle('hidden', currentQuestionIndex === exam.length - 1);
            submitExamBtn.classList.toggle('hidden', currentQuestionIndex !== exam.length - 1);
        }

        // (MODIFIED) Navigasi menggunakan 'currentExamData'
        nextQuestionBtn.addEventListener('click', () => {
            if (currentQuestionIndex < currentExamData.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            }
        });

        prevQuestionBtn.addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
            }
        });
        
        // (MODIFIED) Submit menggunakan 'currentExamData' dan 'showConfirm'
        submitExamBtn.addEventListener('click', () => {
             if (Object.keys(userAnswers).length !== currentExamData.length) {
                showConfirm('Anda belum menjawab semua pertanyaan. Apakah Anda yakin ingin mengumpulkan?', (confirmed) => {
                    if (confirmed) {
                        calculateAndShowResults();
                    }
                });
            } else {
                calculateAndShowResults();
            }
        });
        
        // (MODIFIED) Kalkulasi hasil menggunakan 'currentExamData'
        function calculateAndShowResults() {
            const exam = currentExamData; // Menggunakan data yang sudah diambil
            let score = 0;
            exam.forEach((question, index) => {
                if(userAnswers[index] === question.correct) {
                    score++;
                }
            });
            
            const total = exam.length;
            const percentage = total > 0 ? ((score / total) * 100).toFixed(0) : 0;
            
            document.getElementById('score-text').textContent = `Nilai Anda: ${percentage}`;
            document.getElementById('score-details').textContent = `Anda menjawab benar ${score} dari ${total} soal.`;
            showView('result-view');
        }

    </script>
</body>
</html>