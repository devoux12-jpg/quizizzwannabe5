<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Ujian Online (Soal Lokal)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Impor Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .radio-custom:checked + label {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
            border-color: #3b82f6; /* border-blue-500 */
        }
        .radio-custom + label {
            transition: all 0.2s ease-in-out;
        }
        /* Style untuk Papan Peringkat */
        .leaderboard-table th {
            @apply px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider;
        }
        .leaderboard-table td {
             @apply px-4 py-3 whitespace-nowrap text-sm text-gray-700;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center justify-center min-h-screen">

    <div class="container mx-auto p-4 max-w-2xl w-full">
        <div class="bg-white p-8 rounded-2xl shadow-lg transition-all duration-500">


            <!-- Tampilan Awal -->
            <div id="initial-view" class="view active">
                <h1 class="text-3xl font-bold text-center text-gray-700 mb-2">Selamat Datang!</h1>
                <p class="text-center text-gray-500 mb-8">Silakan buat ujian baru atau masukkan kata sandi untuk memulai ujian.</p>
                <div class="flex flex-col gap-4">
                    <button id="show-create-exam-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        Buat Ujian Baru
                    </button>
                    <div class="border-t border-gray-200 my-2"></div>
                    
                    <h2 class="text-lg font-semibold text-center text-gray-600">Kerjakan Ujian</h2>
                    <!-- Input Nama Peserta -->
                    <input type="text" id="nama-peserta-input" placeholder="Masukkan Nama Anda" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="text" id="password-input" placeholder="Masukkan Kata Sandi Ujian" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="start-exam-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        Mulai Kerjakan
                    </button>

                    <div class="border-t border-gray-200 my-2"></div>
                    <h2 class="text-lg font-semibold text-center text-gray-600">Akses Peringkat (Publik)</h2>
                    <input type="text" id="leaderboard-password-input" placeholder="Masukkan Kata Sandi Ujian untuk Peringkat" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                    <button id="access-leaderboard-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        Lihat Papan Peringkat
                    </button>
                </div>
            </div>

            <!-- Tampilan Buat Ujian (dengan fitur Edit/Hapus) -->
            <div id="create-exam-view" class="view">
                <h1 class="text-2xl font-bold mb-6 text-gray-700">Formulir Pembuatan Soal</h1>
                <div class="space-y-4">
                    <textarea id="question-input" placeholder="Tuliskan pertanyaan Anda di sini..." class="w-full h-28 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                    <input type="text" id="option-a" placeholder="Pilihan Jawaban A" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="option-b" placeholder="Pilihan Jawaban B" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="option-c" placeholder="Pilihan Jawaban C" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="option-d" placeholder="Pilihan Jawaban D" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <select id="correct-answer" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="" disabled selected>Pilih Jawaban Benar</option>
                        <option value="A">Jawaban A</option>
                        <option value="B">Jawaban B</option>
                        <option value="C">Jawaban C</option>
                        <option value="D">Jawaban D</option>
                    </select>
                </div>
                <div class="flex gap-4 mt-6">
                     <!-- Tombol ini akan berubah teks/fungsi saat mode edit aktif -->
                     <button id="add-question-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Tambah Soal</button>
                     <button id="finish-exam-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Selesai & Buat Ujian (Lokal)</button>
                </div>
                 <div class="mt-6">
                    <h3 class="font-semibold text-gray-600">Total Soal: <span id="question-count">0</span></h3>
                    <ul id="questions-list" class="space-y-2 mt-2">
                        <!-- Soal yang ditambahkan akan muncul di sini -->
                    </ul>
                </div>
                <button class="mt-4 text-sm text-gray-500 hover:text-blue-500" onclick="showView('initial-view')">&larr; Kembali ke Menu Utama</button>
            </div>

            <!-- Tampilan Password Ujian -->
            <div id="password-display-view" class="view text-center">
                <h1 class="text-2xl font-bold text-green-600 mb-4">Ujian Berhasil Dibuat (Lokal)!</h1>
                <p class="text-gray-600 mb-4">Bagikan **Kata Sandi Ujian** ini kepada peserta:</p>
                <div class="bg-gray-100 p-4 rounded-lg inline-block border-2 border-dashed border-gray-300 mb-6">
                    <span id="generated-password" class="text-4xl font-mono font-bold tracking-widest text-gray-800"></span>
                </div>
                
                <p class="text-sm text-gray-500 mt-4">Peserta dapat menggunakan kata sandi ini untuk mengerjakan ujian dan melihat papan peringkat.</p>
                
                <button class="mt-8 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg" onclick="showView('initial-view')">Kembali ke Menu Utama</button>
            </div>

            <!-- Tampilan Mengerjakan Ujian -->
            <div id="take-exam-view" class="view">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-2xl font-bold text-gray-700">Soal Ujian</h1>
                     <div class="text-lg font-semibold bg-gray-100 px-4 py-1 rounded-lg">
                        Soal <span id="current-question-number"></span>/<span id="total-questions"></span>
                    </div>
                </div>
                <div id="question-container" class="bg-gray-50 p-6 rounded-lg mb-6">
                    <p id="exam-question" class="text-lg font-medium mb-4"></p>
                    <div id="exam-options" class="space-y-3"></div>
                </div>
                <div class="flex justify-between">
                    <button id="prev-question-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Sebelumnya</button>
                    <button id="next-question-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">Selanjutnya</button>
                    <button id="submit-exam-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg hidden">Kumpulkan</button>
                </div>
            </div>

            <!-- Tampilan Hasil Ujian -->
            <div id="result-view" class="view text-center">
                <h1 class="text-2xl font-bold text-gray-700 mb-4">Hasil Ujian Anda</h1>
                <div class="bg-blue-100 border-t-4 border-blue-500 rounded-b text-blue-900 px-4 py-3 shadow-md mb-6" role="alert">
                  <div class="flex items-center justify-center">
                    <div class="py-1"><svg class="fill-current h-8 w-8 text-blue-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M10 20a10 10 0 1 1 0-20 10 10 0 0 1 0 20zm-1-11V5h2v4h1v2h-1v2h-2v-2H8v-2h1z"/></svg></div>
                    <div>
                      <p class="font-bold text-3xl" id="score-text"></p>
                      <p class="text-sm" id="score-details"></p>
                    </div>
                  </div>
                </div>
                
                <button class="mt-4 w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg" onclick="showView('initial-view')">Lihat Papan Peringkat</button>
                <button class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg" onclick="showView('initial-view')">Kembali ke Menu Utama</button>
            </div>
            
             <!-- Tampilan Papan Peringkat -->
            <div id="leaderboard-view" class="view">
                <h1 class="text-2xl font-bold text-gray-700 mb-4 text-center">Papan Peringkat</h1>
                <p class="text-center text-gray-500 mb-4">Ujian: <span id="leaderboard-password-display" class="font-semibold text-gray-700"></span></p>
                <div class="overflow-x-auto shadow-md rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200 leaderboard-table">
                        <thead>
                            <tr>
                                <th>Ranking</th>
                                <th>Nama Peserta</th>
                                <th>Skor (%)</th>
                                <th>Jawaban Benar</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data Ranking akan dimasukkan di sini oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
                <button class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg" onclick="showView('initial-view')">Kembali ke Menu Utama</button>
            </div>
        </div>
    </div>

    <!-- Modal Kustom (Pengganti alert dan confirm) -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-2xl bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Pemberitahuan</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="modal-message"></p>
                </div>
                <div class="items-center px-4 py-3" id="modal-buttons">
                    <button id="modal-confirm-btn" class="hidden px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                        Ya
                    </button>
                    <button id="modal-cancel-btn" class="hidden ml-3 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Batal
                    </button>
                    <button id="modal-ok-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Modal Functions (Didefinisikan lebih dulu) ---
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        
        let confirmCallback = null;

        function showModal(message) {
            modalTitle.textContent = 'Pemberitahuan';
            modalMessage.textContent = message;
            modalOkBtn.classList.remove('hidden');
            modalConfirmBtn.classList.add('hidden');
            modalCancelBtn.classList.add('hidden');
            modal.classList.remove('hidden');
        }
        
        function showConfirm(message, callback) {
            modalTitle.textContent = 'Konfirmasi';
            modalMessage.textContent = message;
            modalOkBtn.classList.add('hidden');
            modalConfirmBtn.classList.remove('hidden');
            modalCancelBtn.classList.remove('hidden');
            modal.classList.remove('hidden');
            confirmCallback = callback;
        }

        modalOkBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });
        
        modalCancelBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            if (confirmCallback) {
                confirmCallback(false);
                confirmCallback = null;
            }
        });
        
        modalConfirmBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            if (confirmCallback) {
                confirmCallback(true);
                confirmCallback = null;
            }
        });
        // --- End Modal Functions ---

        // =====================================================================
        // --- SUPABASE SETUP (Hanya untuk Hasil Ujian/Peringkat) ---
        // PENTING: GANTI DUA VARIABEL DI BAWAH INI DENGAN KREDENSIAL SUPABASE ANDA YANG ASLI
        const SUPABASE_URL = 'https://wkzufxtjtpnqbbecbjht.supabase.co'; // <--- UBAH BARIS INI
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrenVmeHRqdHBucWJiZWNiamh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MzU4NjgsImV4cCI6MjA3ODMxMTg2OH0.50KwsV4kx_9XQ_sD2HJyCF2qGdl71Xs_t1PUv0DxiB0'; // <--- UBAH BARIS INI
        // =====================================================================
        
        let db;
        let isSupabaseReady = false;
        const { createClient } = supabase;

        try {
            db = createClient(SUPABASE_URL, SUPABASE_KEY);
            if (!db || SUPABASE_URL.includes('dummy') || SUPABASE_KEY.includes('dummy') || !SUPABASE_URL || !SUPABASE_KEY) {
                 throw new Error("Kredensial belum diganti.");
            }
            isSupabaseReady = true;
            console.log("Supabase client initialized for RESULTS and LEADERBOARD.");
        } catch (error) {
            console.error("Inisialisasi Supabase Gagal. Periksa URL dan Key.", error.message);
            document.addEventListener('DOMContentLoaded', () => {
                showModal("PENTING: Gagal terhubung ke Supabase. Papan Peringkat hanya akan bekerja setelah Anda mengganti 'SUPABASE_URL' dan 'SUPABASE_KEY' di kode sumber dengan kredensial Anda.");
            });
        }
        // --- END SUPABASE SETUP ---

        // Database LOKAL untuk soal ujian (Hanya tersimpan di memori JavaScript)
        let currentQuestions = [];
        let editingIndex = -1; 
        let localExams = {}; // Key: password, Value: questions array

        // Data untuk ujian yang *sedang dikerjakan*
        let currentExamData = [];
        let userAnswers = {};
        let currentQuestionIndex = 0;
        
        // Data state untuk peserta
        let currentExamPassword = '';
        let currentParticipantName = '';

        // Elemen-elemen DOM
        const views = document.querySelectorAll('.view');
        const addQuestionBtn = document.getElementById('add-question-btn');
        const questionInput = document.getElementById('question-input');
        const optionAInput = document.getElementById('option-a');
        const optionBInput = document.getElementById('option-b');
        const optionCInput = document.getElementById('option-c');
        const optionDInput = document.getElementById('option-d');
        const correctAnswerSelect = document.getElementById('correct-answer');
        const accessLeaderboardBtn = document.getElementById('access-leaderboard-btn');
        const leaderboardPasswordInput = document.getElementById('leaderboard-password-input');


        // Fungsi untuk menavigasi antar tampilan
        function showView(viewId) {
            views.forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            if (viewId === 'initial-view') {
                // Reset state yang tidak diperlukan di menu awal
                currentQuestions = [];
                currentExamData = [];
                userAnswers = {};
                currentQuestionIndex = 0;
                currentExamPassword = ''; 
                currentParticipantName = ''; 
                editingIndex = -1; 
                renderQuestionsList(); 
                resetQuestionForm(); 
                
                // Reset tombol loading dan input
                document.getElementById('start-exam-btn').disabled = false;
                document.getElementById('start-exam-btn').textContent = 'Mulai Kerjakan';
                document.getElementById('finish-exam-btn').disabled = false;
                document.getElementById('finish-exam-btn').textContent = 'Selesai & Buat Ujian (Lokal)';
                document.getElementById('password-input').value = '';
                document.getElementById('nama-peserta-input').value = '';
                leaderboardPasswordInput.value = ''; 
            }
             if (viewId === 'result-view' && currentExamPassword) {
                 // Ketika kembali ke initial view dari hasil, langsung isi password untuk memudahkan cek peringkat
                leaderboardPasswordInput.value = currentExamPassword;
             }
        }
        
        // Fungsi validasi form pembuatan soal
        function validateQuestionForm() {
            const question = questionInput.value.trim();
            const optA = optionAInput.value.trim();
            const optB = optionBInput.value.trim();
            const optC = optionCInput.value.trim(); 
            const optD = optionDInput.value.trim();
            const correct = correctAnswerSelect.value;

            if (!question || !optA || !optB || !optC || !optD || !correct) {
                showModal('Harap isi semua kolom pertanyaan dan jawaban, serta pilih jawaban yang benar.');
                return false;
            }
            return { question, options: { A: optA, B: optB, C: optC, D: optD }, correct };
        }
        
        // Fungsi untuk mereset form pembuatan soal
        function resetQuestionForm() {
            questionInput.value = '';
            optionAInput.value = '';
            optionBInput.value = '';
            optionCInput.value = '';
            optionDInput.value = '';
            correctAnswerSelect.value = '';
            editingIndex = -1;
            addQuestionBtn.textContent = 'Tambah Soal';
            addQuestionBtn.classList.remove('bg-purple-500', 'hover:bg-purple-600');
            addQuestionBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
        }

        // Fungsi untuk merender daftar soal yang telah ditambahkan
        function renderQuestionsList() {
            const list = document.getElementById('questions-list');
            list.innerHTML = '';
            document.getElementById('question-count').textContent = currentQuestions.length;

            currentQuestions.forEach((q, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 my-2 bg-gray-50 rounded-xl border border-gray-200';
                listItem.innerHTML = `
                    <span class="text-gray-700 font-medium flex-1 mb-2 sm:mb-0 mr-4">
                        <span class="font-bold text-blue-600">${index + 1}.</span> ${q.question.substring(0, 70)}${q.question.length > 70 ? '...' : ''}
                    </span>
                    <div class="space-x-2 flex-shrink-0">
                        <button onclick="editQuestion(${index})" class="text-sm text-blue-500 hover:text-blue-700 font-semibold px-2 py-1 rounded-md border border-blue-500 hover:bg-blue-50">Edit</button>
                        <button onclick="deleteQuestion(${index})" class="text-sm text-red-500 hover:text-red-700 font-semibold px-2 py-1 rounded-md border border-red-500 hover:bg-red-50">Hapus</button>
                    </div>
                `;
                list.appendChild(listItem);
            });
        }
        window.deleteQuestion = deleteQuestion; // Ekspos ke global scope
        window.editQuestion = editQuestion; // Ekspos ke global scope
        
        // --- LOGIKA EDIT & HAPUS SOAL ---

        function editQuestion(index) {
            const q = currentQuestions[index];
            questionInput.value = q.question;
            optionAInput.value = q.options.A;
            optionBInput.value = q.options.B;
            optionCInput.value = q.options.C;
            optionDInput.value = q.options.D;
            correctAnswerSelect.value = q.correct;

            editingIndex = index;
            addQuestionBtn.textContent = 'Simpan Perubahan Soal';
            addQuestionBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            addQuestionBtn.classList.add('bg-purple-500', 'hover:bg-purple-600');

            // Gulir ke atas ke formulir
            document.getElementById('create-exam-view').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteQuestion(index) {
            showConfirm('Apakah Anda yakin ingin menghapus soal ini?', (confirmed) => {
                if (confirmed) {
                    currentQuestions.splice(index, 1);
                    renderQuestionsList();
                    // Jika soal yang sedang diedit dihapus, reset form
                    if (editingIndex === index) {
                         resetQuestionForm(); 
                    }
                    // Perlu cek dan update editingIndex jika indeks yang lebih tinggi dihapus
                    if (editingIndex > index) {
                        editingIndex--;
                    }
                }
            });
        }

        // --- Event Listener Tombol Tambah/Simpan Perubahan ---
        addQuestionBtn.addEventListener('click', () => {
            const questionData = validateQuestionForm();
            if (questionData) {
                if (editingIndex === -1) {
                    // Mode Tambah Baru
                    currentQuestions.push(questionData);
                } else {
                    // Mode Simpan Perubahan (Edit)
                    currentQuestions[editingIndex] = questionData;
                }
                renderQuestionsList();
                resetQuestionForm();
            }
        });

        // --- Event Listener Awal ---
        document.getElementById('show-create-exam-btn').addEventListener('click', () => {
            showView('create-exam-view');
            // Pastikan tombol dalam mode Tambah saat masuk
            resetQuestionForm();
            renderQuestionsList();
        });


        // (LOKAL) Menyimpan ujian
        document.getElementById('finish-exam-btn').addEventListener('click', async () => {
            
            if (currentQuestions.length === 0) {
                showModal('Silakan tambahkan setidaknya satu soal sebelum menyelesaikan.');
                return;
            }

            const finishExamBtn = document.getElementById('finish-exam-btn');
            finishExamBtn.disabled = true;
            finishExamBtn.textContent = 'Menyimpan Lokal...';

            const password = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            // Simpan soal ke memori lokal
            localExams[password] = currentQuestions;
            
            finishExamBtn.disabled = false;
            finishExamBtn.textContent = 'Selesai & Buat Ujian (Lokal)';

            document.getElementById('generated-password').textContent = password;
            showView('password-display-view');
        });

        // (LOKAL) Memulai ujian
        document.getElementById('start-exam-btn').addEventListener('click', async () => {
             
            const participantName = document.getElementById('nama-peserta-input').value.trim();
            const password = document.getElementById('password-input').value.trim().toUpperCase();
            
            if (!participantName) { showModal('Harap masukkan Nama Anda.'); return; }
            if (!password) { showModal('Harap masukkan Kata Sandi Ujian.'); return; }

            const startExamBtn = document.getElementById('start-exam-btn');
            startExamBtn.disabled = true;
            startExamBtn.textContent = 'Mencari Ujian...';

            // Cek di penyimpanan lokal (JavaScript Memory)
            const examData = localExams[password];

            startExamBtn.disabled = false;
            startExamBtn.textContent = 'Mulai Kerjakan';

            if (!examData) {
                showModal('Kata sandi ujian tidak valid atau ujian tidak ditemukan (pastikan Anda belum me-refresh halaman).');
                return;
            }
            
            currentExamData = examData; 
            currentExamPassword = password;
            currentParticipantName = participantName;
            currentQuestionIndex = 0;
            userAnswers = {};
            
            renderQuestion();
            showView('take-exam-view');
        });

        // Render pertanyaan
        function renderQuestion() {
            const exam = currentExamData; 
            const questionData = exam[currentQuestionIndex];
            
            document.getElementById('exam-question').textContent = questionData.question;
            const optionsContainer = document.getElementById('exam-options');
            optionsContainer.innerHTML = '';
            
            Object.entries(questionData.options).forEach(([key, value]) => {
                const optionId = `q${currentQuestionIndex}-opt${key}`;
                const checked = userAnswers[currentQuestionIndex] === key ? 'checked' : '';
                
                const optionHTML = `
                    <div>
                        <input type="radio" name="question${currentQuestionIndex}" id="${optionId}" value="${key}" class="radio-custom hidden" ${checked}>
                        <label for="${optionId}" class="block w-full text-left p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-100">
                            <span class="font-bold mr-2">${key}.</span> ${value}
                        </label>
                    </div>
                `;
                optionsContainer.insertAdjacentHTML('beforeend', optionHTML);
            });
            
            optionsContainer.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    userAnswers[currentQuestionIndex] = e.target.value;
                });
            });

            document.getElementById('current-question-number').textContent = currentQuestionIndex + 1;
            document.getElementById('total-questions').textContent = exam.length;

            document.getElementById('prev-question-btn').disabled = currentQuestionIndex === 0;
            document.getElementById('prev-question-btn').classList.toggle('opacity-50', currentQuestionIndex === 0);
            
            document.getElementById('next-question-btn').classList.toggle('hidden', currentQuestionIndex === exam.length - 1);
            document.getElementById('submit-exam-btn').classList.toggle('hidden', currentQuestionIndex !== exam.length - 1);
        }

        // Navigasi
        document.getElementById('next-question-btn').addEventListener('click', () => {
            if (currentQuestionIndex < currentExamData.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            }
        });

        document.getElementById('prev-question-btn').addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
            }
        });
        
        // Submit ujian
        document.getElementById('submit-exam-btn').addEventListener('click', () => {
             if (Object.keys(userAnswers).length !== currentExamData.length) {
                showConfirm('Anda belum menjawab semua pertanyaan. Apakah Anda yakin ingin mengumpulkan?', (confirmed) => {
                    if (confirmed) {
                        saveAndShowResults();
                    }
                });
            } else {
                saveAndShowResults();
            }
        });
        
        // (SUPABASE) Kalkulasi hasil dan menyimpan ke hasil_ujian
        async function saveAndShowResults() {
             if (!isSupabaseReady) { showModal('Papan Peringkat tidak akan bekerja. Harap ganti kredensial Supabase.'); return; }
             
            const exam = currentExamData; 
            let score = 0;
            exam.forEach((question, index) => {
                if(userAnswers[index] && userAnswers[index] === question.correct) {
                    score++;
                }
            });
            
            const total = exam.length;
            const percentage = total > 0 ? ((score / total) * 100).toFixed(0) : 0;
            
            // Simpan Hasil ke Supabase
            const { error } = await db
                .from('hasil_ujian') // 'hasil_ujian' adalah nama tabel Supabase Anda
                .insert({
                    nama_peserta: currentParticipantName,
                    password_ujian: currentExamPassword,
                    skor: score,
                    total_soal: total
                });

            if (error) {
                console.error('Gagal menyimpan hasil:', error);
                showModal('Gagal menyimpan hasil ke database: ' + error.message);
            }
            
            document.getElementById('score-text').textContent = `Nilai Anda: ${percentage}%`;
            document.getElementById('score-details').textContent = `Anda menjawab benar ${score} dari ${total} soal.`;
            showView('result-view');
        }
        
        // (SUPABASE) Memuat dan Menampilkan Papan Peringkat
        async function loadLeaderboard(examPassword) {
             if (!isSupabaseReady) { showModal('Gagal terhubung ke Supabase. Tidak dapat memuat papan peringkat.'); return; }
             
            const { data: results, error: resultsError } = await db
                .from('hasil_ujian')
                .select('nama_peserta, skor, total_soal')
                .eq('password_ujian', examPassword)
                .order('skor', { ascending: false }); 

            if (resultsError) {
                console.error('Gagal memuat peringkat:', resultsError);
                showModal('Gagal memuat papan peringkat: ' + resultsError.message);
                return;
            }
            
            document.getElementById('leaderboard-password-display').textContent = examPassword;
            const leaderboardBody = document.getElementById('leaderboard-body');
            leaderboardBody.innerHTML = ''; 
            
            results.forEach((result, index) => {
                const percentage = result.total_soal > 0 ? ((result.skor / result.total_soal) * 100).toFixed(0) : 0;
                
                const row = leaderboardBody.insertRow();
                // Terapkan styling untuk peringkat 1-3
                let rankClass = '';
                if (index === 0) rankClass = 'bg-yellow-100 font-bold';
                else if (index === 1) rankClass = 'bg-gray-200 font-semibold';
                else if (index === 2) rankClass = 'bg-amber-100';
                row.className = rankClass;

                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = result.nama_peserta;
                row.insertCell(2).textContent = `${percentage}%`;
                row.insertCell(3).textContent = `${result.skor} / ${result.total_soal}`;
            });

            showView('leaderboard-view');
        }
        
        // (LOKAL + SUPABASE) Logika Akses Peringkat
        accessLeaderboardBtn.addEventListener('click', async () => {
             if (!isSupabaseReady) { showModal('Papan Peringkat tidak akan bekerja. Harap ganti kredensial Supabase.'); return; }
             
            const examPassword = leaderboardPasswordInput.value.trim().toUpperCase();

            if (!examPassword) {
                showModal('Harap masukkan Kata Sandi Ujian untuk melihat peringkat.');
                return;
            }

            // 1. Verifikasi apakah ujian ini ada di memori lokal (HARUS ADA untuk memuat peringkat)
            if (!localExams[examPassword]) {
                showModal('Kata sandi ujian tidak ditemukan di memori lokal (Ujian harus dibuat terlebih dahulu sebelum peringkat dapat dilihat, dan halaman belum boleh di-refresh).');
                return;
            }

            accessLeaderboardBtn.disabled = true;
            accessLeaderboardBtn.textContent = 'Memuat Peringkat...';
            
            // 2. Jika ujian ada, muat peringkat dari Supabase
            await loadLeaderboard(examPassword);
            
            accessLeaderboardBtn.disabled = false;
            accessLeaderboardBtn.textContent = 'Lihat Papan Peringkat';
        });
        
        // Pastikan tombol awal dinonaktifkan jika Supabase belum siap (hanya tombol yang bergantung pada DB)
         document.addEventListener('DOMContentLoaded', () => {
            // Tombol buat ujian dan mulai ujian tidak bergantung pada DB lagi
            document.getElementById('show-create-exam-btn').disabled = false;
            document.getElementById('start-exam-btn').disabled = false;
            // Tombol akses peringkat bergantung pada DB untuk fetch hasil
            document.getElementById('access-leaderboard-btn').disabled = !isSupabaseReady;
        });

    </script>
</body>
</html>
